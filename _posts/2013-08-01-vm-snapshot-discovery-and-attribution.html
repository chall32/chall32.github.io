---
layout: post
title: VM Snapshot Discovery and Attribution
date: '2013-08-01T12:43:00.000+01:00'
tags:
- ESXi
- Reminder
- VMware
- ESX
modified_time: '2013-08-01T12:43:23.919+01:00'
thumbnail: http://1.bp.blogspot.com/-yjK53L-1zas/UfpJSAqzKwI/AAAAAAAABgg/QRKVQElHomU/s72-c/snapshots.jpg
blogger_id: tag:blogger.com,1999:blog-1308168280960455064.post-2432591439461716011
blogger_orig_url: http://chall32.blogspot.com/2013/08/vm-snapshot-discovery-and-attribution.html
---

<div class="ssmainhide"><a href="http://1.bp.blogspot.com/-yjK53L-1zas/UfpJSAqzKwI/AAAAAAAABgg/QRKVQElHomU/s1600/snapshots.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="200" src="http://1.bp.blogspot.com/-yjK53L-1zas/UfpJSAqzKwI/AAAAAAAABgg/QRKVQElHomU/s200/snapshots.jpg" width="200" /></a></div><br />The Golden Snapshot Rule:<br /><div style="text-align: center;"><b><span style="color: #bf9000; font-size: x-large;">VM SNAPSHOTS ARE NOT BACKUPS!</span></b></div><h3>What are VMware VM Snapshots?</h3>Normal VM operation involves the virtual machine (VM) reading and writing to it's virtual disk (VMDK) file:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-9kPN1QYcxWc/UfotOi6JDRI/AAAAAAAABf4/e9ffkzxRqw8/s1600/Normal.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-9kPN1QYcxWc/UfotOi6JDRI/AAAAAAAABf4/e9ffkzxRqw8/s1600/Normal.jpg" /></a></div>Upon the creation of a snapshot, the VM's virtual disk (VMDK) file is marked as read only. <b>All changes are written to a snapshot log file, also known as a 'delta' file</b>:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-codR5cUnDxo/UfotZzEUHjI/AAAAAAAABgA/u0IhGK6kse0/s1600/Snapshot.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-codR5cUnDxo/UfotZzEUHjI/AAAAAAAABgA/u0IhGK6kse0/s1600/Snapshot.jpg" /></a></div><h3><b>So What is the Problem Here?</b></h3>The problem is that these snapshot delta files left unchecked can grow and grow and grow, consuming more and more storage space.<br /><h3><b>Surely VMware Have Some Guidelines Around VM Snapshots?</b></h3>They do, and they are here:&nbsp;<a href="http://kb.vmware.com/kb/1025279%E2%80%8E" target="_blank">http://kb.vmware.com/kb/1025279‎</a><br /><br />Lets pick up on some salient points here as it's worth repeating this as often as possible:<br /><ul><li>Snapshots are not backups <i>(Sound familiar?)</i>&nbsp;</li><li>A snapshot file is only a change log of the original virtual disk</li><li>Snapshots are not complete copies of the original vmdk disk files</li><li>Use no single snapshot for more than 24-72 hours</li><li>Regularly monitor systems configured for backups to ensure that no snapshots remain active for extensive periods of time</li><li>An excessive number of delta files in a chain (caused by an excessive number of snapshots) or large delta files may cause decreased virtual machine and host performance</li><li>If hosts and/or vCenter Server are prior to vSphere 5.0 confirm that there are no snapshots present (via command line) before a Storage vMotion</li><li>Confirm that there are no snapshots present (via command line) before increasing the size of any virtual machine virtual disk or virtual RDM. If snapshots are present, delete them prior to increasing the size of the disk. Increasing the size of a disk with snapshots present can lead to corruption of snapshots and a potential data loss</li></ul><h3>Got it. So How do I quickly and Simply Test for VM Snapshots?</h3>Simple. This is where Chris'&nbsp;VM Snapshot Discovery and Attribution Tool comes in.<br /><br />Here is a screenshot of the tool in action:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-OjZz6Gfxr9w/Ufo2scCNnjI/AAAAAAAABgQ/4NvZesa1VEU/s1600/SnapTool.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="336" src="http://1.bp.blogspot.com/-OjZz6Gfxr9w/Ufo2scCNnjI/AAAAAAAABgQ/4NvZesa1VEU/s400/SnapTool.jpg" width="550" /></a></div><br />So what do we have here?<br /><br />Well, you can quite easily see that both the VM's SPONGEBOB and GARY have active snapshots. You can also see the details around these snapshots; their names, their descriptions and their sizes in GB.<br /><br />What is super cool is we can also see who created them. &nbsp;In the screenshot the snapshot creator is CHLABS\Chris (me!). OK, cool, but <b>think about it for a moment</b>. &nbsp;If this was a production situation, it's more than possible that you will have multiple vSphere administrators. &nbsp;Any one of these administrators can create snapshots.<br /><br />Say for example I found that CHLABS\Fred.Bloggs was working on a some VMs, created several snapshots and had completed his changes. &nbsp;Perhaps Fred did not know or understand The Golden Snapshot Rule.<br /><br />With this newly discovered information now in hand, we can contact Fred, find out if he still needs those snapshots and perhaps educate him to the Golden Snapshot Rule.<br /><br />Perhaps Fred forgot about the snapshots.......<br /><h3>Ah, the Forgotten Snapshot!</h3>Don't joke.... it happens.<br /><h3>Where can I get a Copy of Chris'&nbsp;VM Snapshot Discovery and Attribution Tool?</h3>Simple. Grab your copy here:&nbsp;<a href="https://github.com/chall32/GetSnapshot" target="_blank">https://github.com/chall32/GetSnapshot</a><br /><h3>So I Have VMs With Snapshots. What To Do?</h3>Here are your options:<br /><br /><table cellpadding="0" cellspacing="0" style="border-collapse: collapse; width: 100%;"><tbody><tr> <td style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; padding-bottom: 3px; padding-left: 3px; padding-right: 3px; padding-top: 3px; vertical-align: top; width: 180px;"><br /><div><b><span style="font-family: Arial; font-size: 10pt;">Snapshot Operation</span></b></div></td> <td style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; padding-bottom: 3px; padding-left: 3px; padding-right: 3px; padding-top: 3px; vertical-align: top;"><br /><div><b><span style="font-family: Arial; font-size: 10pt;">Effect</span></b></div></td></tr><tr> <td style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; padding-bottom: 3px; padding-left: 3px; padding-right: 3px; padding-top: 3px; vertical-align: top;"><span style="font-family: Arial; font-size: 10pt;">Take</span></td> <td style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; padding-bottom: 3px; padding-left: 3px; padding-right: 3px; padding-top: 3px; vertical-align: top;"><span style="font-family: Arial; font-size: 10pt;">The current state of the virtual machine and its guest operating system is captured.</span></td></tr><tr> <td style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; padding-bottom: 3px; padding-left: 3px; padding-right: 3px; padding-top: 3px; vertical-align: top;"><span style="font-family: Arial; font-size: 10pt;">Revert</span></td> <td style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; padding-bottom: 3px; padding-left: 3px; padding-right: 3px; padding-top: 3px; vertical-align: top;"><span style="font-family: Arial; font-size: 10pt;">The state of the virtual machine and its guest operating system reverts back to what it was when a snapshot was taken. If there are multiple snapshots, the snapshot taken immediately prior to the current state is used.</span><br /><div><span style="font-family: Arial; font-size: 10pt;"><br /><b>Warning</b>: All current data is permanently lost.</span></div></td></tr><tr> <td style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; padding-bottom: 3px; padding-left: 3px; padding-right: 3px; padding-top: 3px; vertical-align: top;"><span style="font-family: Arial; font-size: 10pt;">Delete</span></td> <td style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; padding-bottom: 3px; padding-left: 3px; padding-right: 3px; padding-top: 3px; vertical-align: top;"><span style="font-family: Arial; font-size: 10pt;">The state of the virtual machine is changed to the current state (that is, changes made after taking the snapshot are saved to the base disk). </span><span style="font-family: Arial; font-size: 10pt;">In earlier versions of some products the menu option is named <b>Remove</b>.</span></td></tr><tr> <td style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; padding-bottom: 3px; padding-left: 3px; padding-right: 3px; padding-top: 3px; vertical-align: top;"><span style="font-family: Arial; font-size: 10pt;">Delete (Snapshot Manager)</span></td> <td style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; padding-bottom: 3px; padding-left: 3px; padding-right: 3px; padding-top: 3px; vertical-align: top;"><span style="font-family: Arial; font-size: 10pt;">The state of the virtual machine is changed to the current state (that is, changes made after taking the snapshot are saved to the base disk).</span><span style="font-family: Arial; font-size: 10pt;"> The snapshot chosen to be deleted is available for selection in a graphical display that shows all existing snapshots. This is available only in products that support multiple snapshots.</span></td></tr><tr> <td style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; padding-bottom: 3px; padding-left: 3px; padding-right: 3px; padding-top: 3px; vertical-align: top;"><span style="font-family: Arial; font-size: 10pt;">Go To (Snapshot Manager)</span></td> <td style="border-bottom: black 1px solid; border-left: black 1px solid; border-right: black 1px solid; border-top: black 1px solid; padding-bottom: 3px; padding-left: 3px; padding-right: 3px; padding-top: 3px; vertical-align: top;"><span style="font-family: Arial; font-size: 10pt;">The state of the virtual machine and its current guest operating system switches to the state of that of an arbitrarily chosen snapshot. The snapshot chosen to switch to is available for selection in a graphical display that shows all existing snapshots. This is available only in products that support multiple snapshots.</span></td></tr></tbody></table><br />May I recommend the Delete option?<br />Sure it doesn't feel right to click "Delete" to carry on as normal with the VM, but it is the correct option!<br /><h3>What Can I Do Longer Term to Prevent Forgotten Snapshots?</h3>Have a look at <a href="http://kb.vmware.com/kb/1018029" target="_blank">http://kb.vmware.com/kb/1018029</a><br />This VMware KB article shows you how to configure VMware vCenter Server to send alerts when virtual machines are running from snapshots.<br /><h3>Conclusion &amp; Troubleshooting</h3>You now know all about VM snapshots, how to test for them, how to find out who created them, and how to delete them.<br /><br />If you need to troubleshoot any issues with VM snapshots, have a look at the bottom of&nbsp;<a href="http://kb.vmware.com/kb/1025279%E2%80%8E" target="_blank">http://kb.vmware.com/kb/1025279‎</a>. There are plenty of resources to look at.<br /><br />- Chris<br /><br /><div class="blogger-post-footer"><p>

