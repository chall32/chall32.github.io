---
comments: true
layout: post
title: Cisco Discovery Protocol For Windows
date: '2009-10-19T23:40:00.011+01:00'
tags:
- XP
- ESXi
- VMware
- ESX
- Cisco
modified_time: '2012-05-23T18:34:19.736+01:00'
thumbnail: http://1.bp.blogspot.com/_2xKZgKYJlJs/StzU3ys3mWI/AAAAAAAAAPQ/gGBUa0bqfII/s72-c/patch.png
blogger_id: tag:blogger.com,1999:blog-1308168280960455064.post-7184689831328791165
blogger_orig_url: http://chall32.blogspot.com/2009/10/cisco-discovery-protocol-for-windows.html
---

<div class="separator" style="clear: both; text-align: center;"><a href="http://www.flickr.com/photos/kevinkemmerer/3007254818/" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;" target="_blank"><img alt="Where do these go? (photo: fangleman)" border="0" src="http://1.bp.blogspot.com/_2xKZgKYJlJs/StzU3ys3mWI/AAAAAAAAAPQ/gGBUa0bqfII/s200/patch.png" title="Where do these go? (photo: fangleman)" /></a></div><b>UPDATE: </b>Checkout and download my CDP client for Windows over <a href="https://github.com/chall32/WinCDP/blob/master/README.md" target="_blank">on github</a><br /><br /><b>&nbsp;</b>Lets face it.&nbsp; We have all been there; "where does this network cable / uplink / port go?"<br /><br />Until now, it has been a matter of looking up cable numbers in databases, fiddling about in the back of server and network racks or worst case - sending the smallest guy down to play hunchback in the windy air conditioned gloom under the floor.<br /><br />There must be a better way to tell where a network cable goes to without having to go to all that trouble every time...<br /><br />Well there is.&nbsp; It's called Cisco Discovery Protocol (CDP).&nbsp; From <a href="http://en.wikipedia.org/wiki/Cisco_Discovery_Protocol" target="_blank">Wikipedia</a>:<br /><br /><blockquote><i>The Cisco Discovery Protocol (CDP) is a proprietary Data Link Layer network protocol developed by Cisco Systems that is implemented in most Cisco networking equipment and is used to share information about other directly connected Cisco equipment, such as the operating system version and IP address. </i></blockquote><br />In other words, CDP packets will give you a lot of valuable information if you can capture them. They will give you all the details of the Cisco switch your on and the port on that switch you're connected to.&nbsp; Of course as CDP is proprietary, you typically won't find it anywhere else other than on Cisco networking kit.<br /><br />However, VMware knew all about this "trace the cable game" when they where putting together ESX and ESXi v3.5.&nbsp; VMware's solution was to build in support for CDP on all physical network interfaces of the ESX Hypervisor:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/_2xKZgKYJlJs/StzZJOmllmI/AAAAAAAAAPY/hvsBTA2eDic/s1600-h/vc-cdp.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/_2xKZgKYJlJs/StzZJOmllmI/AAAAAAAAAPY/hvsBTA2eDic/s320/vc-cdp.PNG" /></a></div><div style="text-align: center;"><span style="font-size: x-small;">VMware CDP in action</span></div><br />Well, this was a revelation!&nbsp; For the first time us server techies can check up on the networks techies.&nbsp; Not only could we tell instantly where a network cable was plugged in, we could tell them if it was in the wrong place too! <i>[bwah ha haaa - rubs hands in a maniacal way!]</i><br /><br />Of course this is OK for VMware Hypervisors and Linux based servers / desktops but what about Windows servers / desktops?<br /><br />Capturing CDP is tough in Windows: <a href="http://freshmeat.net/projects/cdpr/" target="_blank">CDPR</a> will do it, as will <a href="http://www.wireshark.org/" target="_blank">Wireshark</a>, but both require <a href="http://www.winpcap.org/" target="_blank">WinPcap</a> to be installed.&nbsp;  This isn't really practical as potentially I want to find CDP data without installing any additional software or rebooting the host (WinPcap requires a reboot).<br /><br /><span style="font-size: large;"><b>The Solution - TCPDump</b></span><br />I've found a version of TCPDump for Windows that was built on the WinPCap SDK; this means this little 500k utility can capture CDP packets on a machine without any additional tools.&nbsp; What's more, as it's shipped as single command line .exe file, it's portable meaning it can be run from a USB stick, a batchfile, etc.&nbsp; <br /><br />You can get this updated version of TCPDump from <a href="http://www.microolap.com/products/network/tcpdump/download/" target="_blank">micoOLAP</a><br /><br /><span style="font-size: large;"><b>Using TCPDump</b></span><br />Quite simple, but don't be put off by the plethora of switches.<br /><br />Firstly you need to find the interface number of the network adaptor you are trying to find CDP data for.&nbsp; Use this command:<br /><br /><blockquote style="font-family: &quot;Courier New&quot;,Courier,monospace;">tcpdump -D</blockquote><br />This will provide you information similar to this:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/_2xKZgKYJlJs/Stzi0l5SwPI/AAAAAAAAAPg/WK9e5dq5cjk/s1600-h/tcpdump-list.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/_2xKZgKYJlJs/Stzi0l5SwPI/AAAAAAAAAPg/WK9e5dq5cjk/s320/tcpdump-list.PNG" /></a></div><div class="separator" style="clear: both; text-align: center;"><span style="font-size: x-small;">TCPDump Listing Interfaces</span></div><br />I'm interested in capturing data from my HP NC7782 Gigabit Adaptor; interface 2.<br /><br />So lets run the command and capture some CDP data!&nbsp; Here is the command:<br /><br /><blockquote style="font-family: &quot;Courier New&quot;,Courier,monospace;">tcpdump -i 2 -nn -v -s 1500 -c 1 ether[20:2] == 0x2000</blockquote><br />Breaking this down:<br /><ul><li>-i 2 = interface 2</li><li>-nn = not resolving dns or port numbers</li><li>-v = verbose mode</li><li>-s 1500 = snagging up to 1500 bytes of the CDP packet</li><li>-c 1 = capture one packet before exiting&nbsp;</li><li>ether[20:2] == 0x2000 = checking bytes 20 and 21 from the start of the ethernet header for a value of 2000 (hex)</li></ul>Phew! I feel a batch file coming on, because I'm never going to remember all of that!<br /><br />Here is what output looks like:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/_2xKZgKYJlJs/Stzl3cNwdiI/AAAAAAAAAPo/0N_zAcoO6x0/s1600-h/tcpdump.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/_2xKZgKYJlJs/Stzl3cNwdiI/AAAAAAAAAPo/0N_zAcoO6x0/s320/tcpdump.PNG" /></a></div><div class="separator" style="clear: both; text-align: center;"><span style="font-size: x-small;">CDP Data in Windows!</span></div><br />Excellent.<br /><br />Oh and by the way, tell the apprentice he can come out from under the computer room floor now, we know where these cables go.<br /><br /><b>*** UPDATE: 4 May 2010 ***</b><br />Here is the batch file I use to list adaptors, prompt for adaptor number and then run tcpdump on that adaptor:<br /><blockquote style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">@echo off</span><br /><span style="font-size: x-small;">tcpdump -D</span><br /><span style="font-size: x-small;">echo.</span><br /><span style="font-size: x-small;">echo.</span><br /><span style="font-size: x-small;">echo.</span><br /><span style="font-size: x-small;">Set /P adaptor=Please Enter Adaptor Number to Listen on: </span><br /><span style="font-size: x-small;">tcpdump -i %adaptor% -nn -v -s 1500 -c 1 ether[20:2] == 0x2000</span><br /><span style="font-size: x-small;">pause</span></blockquote><br />- Chris<div class="blogger-post-footer"><p>

